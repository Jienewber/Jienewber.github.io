<!DOCTYPE html>
<html>
  <head>
    <title>3.1 Transitions</title>
    <meta charset=utf-8>
    <meta name=viewport content="width=device-width, initial-scale=1.0">
    <!-- CSS Imports -->
    <link rel="stylesheet" href="css/leaflet.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/style.css" />
    <!-- Load D3js library and d3.tip library -->
    <script src="https://d3js.org/d3.v4.js" charset="utf-8"></script>
  </head>

  <body>
    <!-- Header, Board for D3 drawing, and Sidebar -->
    <div class="header"></div>
    <div id="container" class="board"></div>
    <div class="sidebar">
      <h1>Transition in D3 Way</h1>
      <p>Source: DUSPviz - D3 Workshop Series 3<br><a href="http://duspviz.mit.edu/d3-workshop/transitions-animation/">Interaction and Animation: D3 Transitions, Behaviors, and Brushing</a></p>
      <h2>Part 1: Rectangle</h2>
        <button id="start">Transition</button>
        <button id="reset" style="margin-left: 5px">Reset</button>
      <h2>Part 2: Scatterplot - Adding Transitions between Data Fields</h2>
        <button id="startPlot">Year 2016</button>
        <button id="resetPlot" style="margin-left: 5px">Year 2015</button>
      <h2>Part 3: Bar Chart</h2>
        <button id="ratdata1" checked>Dataset 1</button>
        <button id="ratdata2" style="margin-left: 5px">Dataset 2</button>
    </div>

    <script>

    // Part 1 Rectangle
    var svgContainer1 = d3.select("div.board").append("svg")
      .attr("width", 300)
      .attr("height", 150)
      .style("border-color", "black")
      .style("border-style", "solid")
      .style("border-width", "1px");

     
    // Draw the Rectangle
    var rectangle = svgContainer1.append("rect")
      .attr("x", 50)
      .attr("y", 50)
      .attr("width", 50)
      .attr("height", 50);

    d3.select("#start").on("click", function() {
      d3.selectAll("rect")
        .transition()
        .attr("width", 100)
        .attr("height", 100) // new size
        .attr("opacity", 0.5) // new opacity
        .attr("fill", "red") // new color
        .attr("x", 200) // new position
        .delay(500) // delay 500ms(0.5s) before the start of the transition
        .duration(2500) // Set Duration, default is 250ms
        .ease(d3.easeBounce)
        .on("end",function() { // on end of first transition...
            d3.select(this)
              .transition() // second transition
              .attr("width", 75) // second width
              .attr("height", 75) // second height
              .attr("opacity", 0.75) // second opacity
              .attr("fill", "blue") // second color
              .attr("x", 150) // second x
              .delay(500) // second delay
              .duration(2500) // second time
              .ease(d3.easeBounce); // second ease
        });
    });

    d3.select("#reset").on("click", function() {
      rectangle
        .transition()
        .attr("width", 50)
        .attr("height", 50)
        .attr("opacity", 1)
        .attr("fill", "black")
        .attr("x", 50)
        .duration(2500); 
    });

    // Part 2 Scatterplot
    var dataset = [];

    d3.csv("data/coffee_rodents_transform.csv", function(d) {
      return {
        city : d.city,
        rats2015 : +d.rats_2015, // new field
        coffee2015 : +d.coffee_2015, // new field
        rats2016 : +d.rats_2016, // new field
        coffee2016 : + d.coffee_2016 // new field
      };
    }, function(error, rows) {
      if (error) throw error;
      dataset = rows;
      console.log(dataset);
      createVisualization(dataset);
    });

    var svgWidth = 300,
        svgHeight = 400,
        margin = {top: 0, right: 0, bottom: 0, left: 0},
        width = svgWidth - margin.left - margin.right,
        height = svgHeight - margin.top - margin.bottom,
        svgContainer2 = d3.select("div.board")
          .append("svg")  // The append() method creates a new element as a child of each element in the current selection
          .attr("y", 180)
          .attr("width", svgWidth)
          .attr("height", svgHeight)
          .attr("style", "outline: thin solid maroon"),
        g = svgContainer2.append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
          .attr("style", "outline: black");


    function createVisualization(data) {
      // set padding and scales for x (0 to max of the two rats column), y (0 to max of the two coffee columns)
      var padding = 50,
      x = d3.scaleLinear()
        .domain([0, d3.max(dataset, function(d) { 
            return (d.rats2015<d.rats2016)?d.rats2016:d.rats2015;})])
        .rangeRound([padding, width - padding]), // reverse y to make the larger values on the top
      y = d3.scaleLinear()
        .domain([0, d3.max(dataset, function(d) { 
          return (d.coffee2015<d.coffee2016)?d.coffee2016:d.coffee2015;})])
        .rangeRound([height - padding, padding]); // reverse y to make the larger values on the top

      // Add scatter points
      var circles = g.append("g")
          .selectAll(".cir")
          .data(data)
          .enter().append("circle")
          .attr("class", "cir")
          .attr("cx", function(d) { return x(d.rats2015); })
          .attr("cy", function(d) { return y(d.coffee2015); })
          .attr("r", 5);

        // Add text for x, y, and r
      var notes = g.append("g")
          .selectAll("text")
          .data(data)
          .enter().append("text")
          .text(function(d) {
            return d.city + ": " + d.rats2015 + ", " + d.coffee2015;
          })
          .attr("x", function(d) { return x(d.rats2015); })
          .attr("y", function(d) { return y(d.coffee2015); });

      // Add axis 
      g.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(0," + (height-padding) + ")")
            .call(d3.axisBottom(x));

      g.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(" + padding + ", 0)")
            .call(d3.axisLeft(y).ticks(null, "s"))
            .append("text")
            .attr("x", 2 )
            .attr("y", y(y.ticks().pop()))
            .attr("font-weight", "bold") // specify the font style of Amount
            .attr("text-anchor", "start")
            .text("Amount");

      // Add button's event listeners
      d3.select("#startPlot").on("click", function() {
          circles
            .transition()
            .attr("cx", function(d) { return x(d.rats2016); })
            .attr("cy", function(d) { return y(d.coffee2016); });
          notes
            .transition()
            .text(function(d) {
                return d.city + ": " + d.rats2016 + ", " + d.coffee2016;
            })
            .attr("x", function(d) { return x(d.rats2016); })
            .attr("y", function(d) { return y(d.coffee2016); });
        });

        d3.select("#resetPlot").on("click", function() {
          circles
            .transition()
            .attr("cx", function(d) { return x(d.rats2015); })
            .attr("cy", function(d) { return y(d.coffee2015); });
          notes
            .transition()
            .text(function(d) {
                return d.city + ": " + d.rats2015 + ", " + d.coffee2015;
            })
            .attr("x", function(d) { return x(d.rats2015); })
            .attr("y", function(d) { return y(d.coffee2015); });
        });
    }

    // Part 3: Bar Chart
    var ratChanges = [];

    d3.select("#ratdata1").on("click", function() {
        d3.csv("data/rat-data-1.csv", function(d) {
          return {
            city : d.city,
            rats : +d.rats
          };
        }, function(error, rows) {
          if (error) throw error;
          ratChanges = rows;
          console.log(ratChanges);
          updateChange(ratChanges);
        });  
    });

    d3.select("#ratdata2").on("click", function() {
        d3.csv("data/rat-data-2.csv", function(d) {
          return {
            city : d.city,
            rats : +d.rats
          };
        }, function(error, rows) {
          if (error) throw error;
          ratChanges = rows;
          console.log(ratChanges);
          updateChange(ratChanges);
        });  
    });

    var svgContainer3 = d3.select("div.board")
          .append("svg")  // The append() method creates a new element as a child of each element in the current selection
          .attr("width", svgWidth)
          .attr("height", svgHeight)
          .attr("style", "outline: thin solid maroon");

    function updateChange(dataset) {
        var padding = 20,
        y = d3.scaleLinear()
              .domain([0, d3.max(dataset, function(d) {return d.rats;})])
              .rangeRound([height - padding, padding]);

        svgContainer3.selectAll("rect")
            .data(dataset)
            .enter()
            .append("rect")
            .transition()
            .attr("y", function(d) { return height - padding - y(d.rats);}) // Set y coordinate of rect using the y scale
            .attr("height", function(d) {return y(d.rats);}) // Set height of using the scale
            .attr("fill", "maroon");
            // .on("mouseover", function(d){
            //   return tooltip.style("visibility", "visible").text(d.city + ": " + d.rats);
            // })
            // .on("mousemove", function(d){
            //   return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px").text(d.city + ": " + d.rats);
            // }) // d3.event.pageX / d3.event.pageY is the current mouse coordinate.
            // // Notes: separate those two mouseovers, so that the label could move along with the mouse, otherwise it will stick to the original location until you move the mouse out and over again.
            // .on("mouseout", function(d){
            //   return tooltip.style("visibility", "hidden");
            // });
     }



    </script>


  </body>
</html>
